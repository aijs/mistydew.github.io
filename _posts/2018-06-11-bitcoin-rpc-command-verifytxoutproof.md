---
layout: post
title:  "比特币 RPC 命令剖析 \"verifytxoutproof\""
date:   2018-06-11 11:43:35 +0800
author: mistydew
categories: Blockchain
---
![bitcoin](/images/20180504/bitcoin.svg)

## 读在前面
比特币相关的解读目前均采用 [bitcoin v0.12.1](https://github.com/bitcoin/bitcoin/tree/v0.12.1)，此版本为官方内置挖矿算法的最后一版。<br>
目前比特币的最新版本为 bitcoin v0.16.0，离区块链 1.0 落地还有些距离。

## 提示说明

{% highlight shell %}
verifytxoutproof "proof" # 验证一个指向块上交易的证明，返回它提交的交易并且如果该块不在最佳链上则抛出一个 RPC 错误
{% endhighlight %}

参数：<br>
1. `proof` （字符串，必备）通过 [`gettxoutproof`](/2018/06/11/bitcoin-rpc-command-gettxoutproof) 生成的 16 进制证明。

结果：（数组，字符串）证明提交的交易索引集，或如果证明无效则为空数组。

## 用法示例

{% highlight shell %}
$ bitcoin-cli gettxoutproof [\"5d306125b2fbfc5855b1b7729ceac1b3010e0ddaa7b03f7abeb225f7b13677ff\"]
00000020833c129fd31f08097043e99c9c402d321b0c4adc7113c311eae61f3985040000a2de87bfe308217d7f081364e6226348d43826b37784c79f22b1efd9a29e97655bc0045b1212221e23850d006400000008422f3ac5676e74eb5897bf995da0ff25b4a17cb159c90291f0f806da6be926d5aaba707d3d33d66536b8ff50555224a4fa4fe6ed12223e48bfa907bc9cb1d746ff7736b1f725b2be7a3fb0a7da0d0e01b3c1ea9c72b7b15558fcfbb22561305d909a82f522c54603f5ee8a936c891f6310352bba789c2b74770c876561eb31b3cad1e95caaa026649a86e12f92d0a16e8614a8a0160ce19a96820906a0bf138940f37ed5368c71c23c086b2872c528462fdb8742446abe73272e22d157a5eacbdbcd89202b0090b2e14347c1aba39bd3588f853ce6c0be70e1a3baae7abba75ee96f4c02790982171633df9576a90701ad0f1bea6e526fd7f3d95571031503af02db03
$ bitcoin-cli verifytxoutproof 00000020833c129fd31f08097043e99c9c402d321b0c4adc7113c311eae61f3985040000a2de87bfe308217d7f081364e6226348d43826b37784c79f22b1efd9a29e97655bc0045b1212221e23850d006400000008422f3ac5676e74eb5897bf995da0ff25b4a17cb159c90291f0f806da6be926d5aaba707d3d33d66536b8ff50555224a4fa4fe6ed12223e48bfa907bc9cb1d746ff7736b1f725b2be7a3fb0a7da0d0e01b3c1ea9c72b7b15558fcfbb22561305d909a82f522c54603f5ee8a936c891f6310352bba789c2b74770c876561eb31b3cad1e95caaa026649a86e12f92d0a16e8614a8a0160ce19a96820906a0bf138940f37ed5368c71c23c086b2872c528462fdb8742446abe73272e22d157a5eacbdbcd89202b0090b2e14347c1aba39bd3588f853ce6c0be70e1a3baae7abba75ee96f4c02790982171633df9576a90701ad0f1bea6e526fd7f3d95571031503af02db03
[
  "5d306125b2fbfc5855b1b7729ceac1b3010e0ddaa7b03f7abeb225f7b13677ff"
]
{% endhighlight %}

## 源码剖析
`verifytxoutproof` 对应的函数在“rpcserver.h”文件中被引用。

{% highlight C++ %}
extern UniValue verifytxoutproof(const UniValue& params, bool fHelp); // 验证交易证明
{% endhighlight %}

实现在“rpcrawtransaction.cpp”文件中。

{% highlight C++ %}
UniValue verifytxoutproof(const UniValue& params, bool fHelp)
{
    if (fHelp || params.size() != 1) // 参数必须为 1 个
        throw runtime_error( // 命令帮助反馈
            "verifytxoutproof \"proof\"\n"
            "\nVerifies that a proof points to a transaction in a block, returning the transaction it commits to\n"
            "and throwing an RPC error if the block is not in our best chain\n"
            "\nArguments:\n"
            "1. \"proof\"    (string, required) The hex-encoded proof generated by gettxoutproof\n"
            "\nResult:\n"
            "[\"txid\"]      (array, strings) The txid(s) which the proof commits to, or empty array if the proof is invalid\n"
        );

    CDataStream ssMB(ParseHexV(params[0], "proof"), SER_NETWORK, PROTOCOL_VERSION); // 获取指定交易证明初始化数据流对象
    CMerkleBlock merkleBlock;
    ssMB >> merkleBlock; // 导出到 CMerkleBlock 对象中

    UniValue res(UniValue::VARR); // 数组类型的返回对象

    vector<uint256> vMatch; // 用于保存交易索引
    if (merkleBlock.txn.ExtractMatches(vMatch) != merkleBlock.header.hashMerkleRoot) // 提取交易索引列表
        return res;

    LOCK(cs_main); // 上锁

    if (!mapBlockIndex.count(merkleBlock.header.GetHash()) || !chainActive.Contains(mapBlockIndex[merkleBlock.header.GetHash()])) // 区块索引映射列表中包含该区块（头）索引 且 激活的链包含该区块
        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, "Block not found in chain");

    BOOST_FOREACH(const uint256& hash, vMatch) // 遍历交易索引列表
        res.push_back(hash.GetHex()); // 加入结果集
    return res; // 返回结果
}
{% endhighlight %}

基本流程：<br>
1.处理命令帮助和参数个数。<br>
2.获取交易证明，并从该证明中提取交易索引列表。<br>
3.上锁。<br>
4.验证交易所在区块是否为有效区块。<br>
5.遍历交易索引列表，加入结果集并返回。

Thanks for your time.

## 参照
* [Developer Documentation - Bitcoin](https://bitcoin.org/en/developer-documentation)
* [Bitcoin Developer Reference - Bitcoin](https://bitcoin.org/en/developer-reference#verifytxoutproof)
* [精通比特币（第二版） \| 巴比特图书](http://book.8btc.com/masterbitcoin2cn)
* [...](https://github.com/mistydew/blockchain)
