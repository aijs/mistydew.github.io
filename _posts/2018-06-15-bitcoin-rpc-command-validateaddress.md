---
layout: post
title:  "比特币 RPC 命令剖析 \"validateaddress\""
date:   2018-06-15 09:12:36 +0800
author: mistydew
categories: Blockchain
---
![bitcoin](/images/20180504/bitcoin.svg)

## 读在前面
比特币相关的解读目前均采用 [bitcoin v0.12.1](https://github.com/bitcoin/bitcoin/tree/v0.12.1)，此版本为官方内置挖矿算法的最后一版。<br>
目前比特币的最新版本为 bitcoin v0.16.0，离区块链 1.0 落地还有些距离。

## 提示说明

{% highlight shell %}
validateaddress "bitcoinaddress" # 获取关于给定比特币地址的信息（不含余额）
{% endhighlight %}

参数：<br>
1. `bitcoinaddress` （字符串，必备）用于有效化的比特币地址。

结果：<br>
{% highlight shell %}
{
  "isvalid" : true|false,       (boolean) If the address is valid or not. If not, this is the only property returned.
  "address" : "bitcoinaddress", (string) The bitcoin address validated
  "scriptPubKey" : "hex",       (string) The hex encoded scriptPubKey generated by the address
  "ismine" : true|false,        (boolean) If the address is yours or not
  "iswatchonly" : true|false,   (boolean) If the address is watchonly
  "isscript" : true|false,      (boolean) If the key is a script
  "pubkey" : "publickeyhex",    (string) The hex value of the raw public key
  "iscompressed" : true|false,  (boolean) If the address is compressed
  "account" : "account"         (string) DEPRECATED. The account associated with the address, "" is the default account
}
{% endhighlight %}

## 用法示例

用法一：验证本钱包中的地址。

{% highlight shell %}
$ bitcoin-cli validateaddress 1kYaQpexBapKmBrGku9e7FEZcZbyrC3xej
{
  "isvalid": true,
  "address": "1kYaQpexBapKmBrGku9e7FEZcZbyrC3xej",
  "scriptPubKey": "76a914a2ca1135287d06f6dbcd4c700a82ede041b6c4b988ac",
  "ismine": true,
  "iswatchonly": false,
  "isscript": false,
  "pubkey": "028b7fd185c5551652acb6ed3ce029063f17b2d6b22053f58c336b624f9e9c10f0",
  "iscompressed": true,
  "account": ""
}
{% endhighlight %}

用法二：验证非本钱包中的地址。

{% highlight shell %}
$ bitcoin-cli validateaddress 1kfeeVpPJkRGv2XQQeB8bJn835okz7fkBw
{
  "isvalid": true,
  "address": "1kfeeVpPJkRGv2XQQeB8bJn835okz7fkBw",
  "scriptPubKey": "76a914a42083c9f9f9f5134c702746c072118c9f74124588ac",
  "ismine": false,
  "iswatchonly": false,
  "isscript": false
}
{% endhighlight %}

用法三：验证错误地址，这里的地址前缀错误。

{% highlight shell %}
$ bitcoin-cli validateaddress 2kfeeVpPJkRGv2XQQeB8bJn835okz7fkBw
{
  "isvalid": false
}
{% endhighlight %}

## 源码剖析
`validateaddress` 对应的函数在“rpcserver.h”文件中被引用。

{% highlight C++ %}
extern UniValue validateaddress(const UniValue& params, bool fHelp); // 验证地址
{% endhighlight %}

实现在“rpcmisc.cpp”文件中。

{% highlight C++ %}
UniValue validateaddress(const UniValue& params, bool fHelp)
{
    if (fHelp || params.size() != 1) // 参数必须为 1 个
        throw runtime_error( // 命令帮助反馈
            "validateaddress \"bitcoinaddress\"\n"
            "\nReturn information about the given bitcoin address.\n"
            "\nArguments:\n"
            "1. \"bitcoinaddress\"     (string, required) The bitcoin address to validate\n"
            "\nResult:\n"
            "{\n"
            "  \"isvalid\" : true|false,       (boolean) If the address is valid or not. If not, this is the only property returned.\n"
            "  \"address\" : \"bitcoinaddress\", (string) The bitcoin address validated\n"
            "  \"scriptPubKey\" : \"hex\",       (string) The hex encoded scriptPubKey generated by the address\n"
            "  \"ismine\" : true|false,        (boolean) If the address is yours or not\n"
            "  \"iswatchonly\" : true|false,   (boolean) If the address is watchonly\n"
            "  \"isscript\" : true|false,      (boolean) If the key is a script\n"
            "  \"pubkey\" : \"publickeyhex\",    (string) The hex value of the raw public key\n"
            "  \"iscompressed\" : true|false,  (boolean) If the address is compressed\n"
            "  \"account\" : \"account\"         (string) DEPRECATED. The account associated with the address, \"\" is the default account\n"
            "}\n"
            "\nExamples:\n"
            + HelpExampleCli("validateaddress", "\"1PSSGeFHDnKNxiEyFrD1wcEaHr9hrQDDWc\"")
            + HelpExampleRpc("validateaddress", "\"1PSSGeFHDnKNxiEyFrD1wcEaHr9hrQDDWc\"")
        );

#ifdef ENABLE_WALLET
    LOCK2(cs_main, pwalletMain ? &pwalletMain->cs_wallet : NULL); // 钱包上锁
#else
    LOCK(cs_main);
#endif

    CBitcoinAddress address(params[0].get_str()); // 获取指定的比特币地址
    bool isValid = address.IsValid(); // 判断地址是否有效

    UniValue ret(UniValue::VOBJ); // 对象类型的返回结果
    ret.push_back(Pair("isvalid", isValid)); // 有效性
    if (isValid) // 若有效
    {
        CTxDestination dest = address.Get(); // 从比特币地址获取交易目的地址
        string currentAddress = address.ToString();
        ret.push_back(Pair("address", currentAddress)); // 当前比特币地址

        CScript scriptPubKey = GetScriptForDestination(dest); // 从交易目的地址获取脚本公钥
        ret.push_back(Pair("scriptPubKey", HexStr(scriptPubKey.begin(), scriptPubKey.end()))); // 脚本公钥

#ifdef ENABLE_WALLET
        isminetype mine = pwalletMain ? IsMine(*pwalletMain, dest) : ISMINE_NO;
        ret.push_back(Pair("ismine", (mine & ISMINE_SPENDABLE) ? true : false)); // 是否属于我的
        ret.push_back(Pair("iswatchonly", (mine & ISMINE_WATCH_ONLY) ? true: false)); // 是否为 watch-only 地址
        UniValue detail = boost::apply_visitor(DescribeAddressVisitor(), dest); // 排序
        ret.pushKVs(detail); // 地址细节
        if (pwalletMain && pwalletMain->mapAddressBook.count(dest)) // 若钱包可用 且 该目的地址在地址簿中
            ret.push_back(Pair("account", pwalletMain->mapAddressBook[dest].name)); // 获取该地址关联的账户名
#endif
    }
    return ret; // 返回结果
}
{% endhighlight %}

基本流程：<br>
1.处理命令帮助和参数个数。<br>
2.上锁，若开启钱包功能，钱包上锁。<br>
3.获取指定的比特币地址，并判断该地址是否有效。<br>
4.获取相关地址信息，判断该地址是否属于自己并添加到结果对象中。<br>
5.返回结果。

Thanks for your time.

## 参照
* [Developer Documentation - Bitcoin](https://bitcoin.org/en/developer-documentation)
* [Bitcoin Developer Reference - Bitcoin](https://bitcoin.org/en/developer-reference#validateaddress)
* [精通比特币（第二版） \| 巴比特图书](http://book.8btc.com/masterbitcoin2cn)
* [...](https://github.com/mistydew/blockchain)
